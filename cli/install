#!/usr/bin/env bash

set -e

# ==========================
# RGB Gradient Progress Bar
# ==========================
progress_rgb() {
  local duration=$1
  local width=${2:-40}

  for ((i=0; i<=width; i++)); do
    percent=$(( i * 100 / width ))

    # Gradien Merah -> Hijau, B tetap 100
    R=$((255 - (i*255/width)))
    G=$((i*255/width))
    B=100

    bar=$(printf "%-${i}s" "#")
    printf "\r\033[48;2;%s;%s;%sm%-*s\033[0m %d%%" "$R" "$G" "$B" $((width-i)) "" "$percent"

    sleep $(bc -l <<< "$duration/$width")
  done
  echo ""
}

# ==========================
# Spinner
# ==========================
spinner() {
  local pid=$1
  local delay=0.1
  local spinstr='|/-\'
  while kill -0 $pid 2>/dev/null; do
    for i in $(seq 0 3); do
      printf "\r${spinstr:i:1} "
      sleep $delay
    done
  done
  echo ""
}

# ==========================
# Parse Arguments
# ==========================
PLUGINS=()
LINK=false

for arg in "$@"; do
  case $arg in
    --plugins=*)
      IFS=',' read -ra PLUGINS <<< "${arg#*=}"
      ;;
    --link=true)
      LINK=true
      ;;
  esac
done

if [ ${#PLUGINS[@]} -eq 0 ]; then
  echo "‚ùå No plugin specified! Use --plugins=<plugins-name>"
  exit 1
fi

echo ""
echo "========================="
echo "   JDX Dependency Installer"
echo "========================="
echo ""

# ==========================
# Plugin Loop
# ==========================
for PLUGIN in "${PLUGINS[@]}"; do
  PLUGIN_PATH="$HOME/jdx-plugins/plugins/$PLUGIN"

  echo "üìÇ Going to plugin: $PLUGIN..."
  if [ ! -d "$PLUGIN_PATH" ]; then
    echo "‚ùå Plugin not found: $PLUGIN_PATH"
    continue
  fi
  cd "$PLUGIN_PATH"

  echo "üì¶ Installing dependencies..."
  npm install --silent &
  pid=$!
  progress_rgb 3
  wait $pid

  if [ "$LINK" = true ]; then
    echo "üîó Linking CLI..."
    npm link &
    pid=$!
    progress_rgb 2
    wait $pid
  fi

  echo "üß™ Testing CLI..."
  "$PLUGIN" --help >/dev/null 2>&1
  CODE=$?

  echo ""
  if [ "$CODE" -eq 0 ]; then
    echo "‚úÖ $PLUGIN Test Completed. Exit code 0, Yayyy :)"
  else
    echo "‚ùå $PLUGIN Test Failed. Exit code $CODE, nooo :("
  fi
  echo ""
done

echo "üéâ All done!"